<html>
<head>
	<script data-joshfire-bootstrap src="http://localhost:40021/bootstrap/4ed4b24582d630000000019a/auto/auto/"></script>	
	<link rel="stylesheet" href="preview.css">
</head>
<body>

<div id="preview">Loading...</div>

<script>

	var skip = 0;
	var limit = 20;
	var maxid = false;

	var formatData = function (data) {
		var str = "";
		var i = 0;
		var entry = null;

		if (!data || !data.entries || !data.entries.length) {
			return "";
		}
		
		for (i = 0; i < data.entries.length; i++) {
			entry = data.entries[i];
			str += '<li>';
    
			if (entry.name) {
				str += '<h4>' + entry.name + '</h4>';
			}

			if (entry.thumbnailUrl) {
				str += '<p><img src="' + entry.thumbnailUrl + '" alt="" /></p>';
			}
			else if (entry.thumbnail && entry.thumbnail[0] && entry.thumbnail[0].contentURL) {
				str += '<p><img src="' + entry.thumbnail[0].contentURL + '" alt="" /></p>';
			}

			/*
			if (entry.description) {
				str += '<p>' + entry.description + '</p>';
			}
			*/

			str += '</li>';
			
			maxid = entry.url;
		}
		skip += data.entries.length;
		
		return str;
	};

	var loadMore = function (first) {
		var str = "";
		
		if (!first) {
			document.getElementById("preview-loadmore").innerHTML="Loading...";
		}
		
		var ds = Joshfire.factory.getDataSource("main");
		if (ds.children) ds = ds.children[0];
		var options = {skip:skip,limit:limit};
		if (maxid) options.maxid = maxid;
		ds.find(options,function (err, data) {
			if (err) {
				str = "An error occurred or the service may be temporarily down.";
			}
			else if (first) {
				if (!data || !data.entries || !data.entries.length) {
					str = 'No entries';
				}
				else {
					str = '<ul id="preview-ul"></ul><a id="preview-loadmore" onclick="loadMore(); return false;" href="#"></a>';
				}
				document.getElementById("preview").innerHTML = str;
			}

			if (document.getElementById("preview-loadmore")) {
				document.getElementById("preview-loadmore").innerHTML = "Load more";
				if (data && data.entries && data.entries.length) {
					document.getElementById("preview-ul").innerHTML += formatData(data);	
				}
			}
			
		});
	};

	loadMore(true);
	
</script>
</body>
</html>