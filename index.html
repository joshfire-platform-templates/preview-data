<html>
<head>
	<script data-joshfire-bootstrap src="http://localhost:40021/bootstrap/4ed4b24582d630000000019a/auto/auto/"></script>
	<script>(function() {

  //todo merge in Joshfire?
  window.JoshfirePlatformConfig = {"HOST":"localhost","PORT":"40021","HOSTPORT":"localhost:40021","DATAHOST":"localhost","DATAPORT":"40020","DATAHOSTPORT":"localhost:40020"};

  var Joshfire = window.Joshfire || {};


  Joshfire.factory = { config: {"app":{"name":"Feed test","description":"Blah"},"template":{"name":"default","version":"0.0.1","options":{}}} };

  Joshfire.factory.config.datasources = {
	  "main": [
      {
        "name": "ical",
        "db": "feed",
        "col": "ical",
        "query": {
          "filter": {
            "url": "https://www.google.com/calendar/ical/ii0slsuvnltb4cen10o0ottvi0%40group.calendar.google.com/private-b791f8be42050c0afa3fd9dc8c6f3b63/basic.ics"
          }
        }
      },
      {
        "name": "web",
        "db": "feed",
        "col": "web",
        "query": {
          "filter": {
            "url": "http://joshfire.com"
          }
        }
      },
      {
        "name": "viewtext",
        "db": "feed",
        "col": "viewtext",
        "query": {
          "filter": {
            "url": "http://joshfire.com"
          }
        }
      },
      {
        "name": "Spreadsheet",
        "db": "google",
        "col": "spreadsheets",
        "query": {
          "filter": {
            "docid": "0ArnpnObxnz4RdHNDYUwtdkVSMjRnbDFwRVlvOWJzSnc",
            "sheetid": 1,
            "usestdmapping": true
          }
        }
      },
      {
        "name": "RSS",
        "db": "feed",
        "col": "rss",
        "query": {
          "filter": {
            "url": "http://www.w3.org/News/news.rss"
          }
        }
      },
	  	{
		  	"name": "twitter93",
		  	"db": "twitter",
		  	"col": "tweets",
		  	"query": {
				  "filter": {
				  	"search": "#joshfire",
				  	"user":""
					}
				}
			},
			{
		  	"name": "flickr",
		  	"db": "flickr",
		  	"col": "photos",
		  	"query": {
				  "filter": {
				  	"search": "joshfire",
				  	"user":""
					}
				}
			},
			{
				"name": "youtube",
				"db": "youtube",
				"col": "videos",
				"query": {
					"filter": {
						"search": "joshfire"
					}
				}
			}
		]
	};

  (function(config) {

  var _extend = function(obj1,obj2) {
    for (var key in obj2 ) {
      if ( obj2.hasOwnProperty(key) ) {
        obj1[key] = obj2[key];
      }
    }
    return obj1;
  };

  // https://github.com/IntoMethod/Lightweight-JSONP
  var JSONP = (function(){
    var counter = 0, head, query, key;
    function load(url) {
      var script = document.createElement('script'),
        done = false;
      script.src = url;
      script.async = true;
   
      script.onload = script.onreadystatechange = function() {
        if ( !done && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") ) {
          done = true;
          script.onload = script.onreadystatechange = null;
          if ( script && script.parentNode ) {
            script.parentNode.removeChild( script );
          }
        }
      };
      if ( !head ) {
        head = document.getElementsByTagName('head')[0];
      }
      head.appendChild( script );
    }
    function jsonp(url, params, callback) {
      query = "?";
      params = params || {};
      for ( key in params ) {
        if ( params.hasOwnProperty(key) ) {
          query += encodeURIComponent(key) + "=" + encodeURIComponent(params[key]) + "&";
        }
      }
      var jsonp = "json" + (++counter);
      window.DatajsProxy[ jsonp ] = function(data){
        callback(data);
        try {
          delete window.DatajsProxy[ jsonp ];
        } catch (e) {}
        window.DatajsProxy[ jsonp ] = null;
      };
   
      load(url + query + "callback=DatajsProxy." + jsonp);
      return jsonp;
    }
    return {
      get:jsonp
    };
  }());


  var collection = function(db, colname, options) {
    
    options = options || {};

    this.find = function(query, callback) {

      var finalQuery = {};
      _extend(finalQuery,options); //Clone default options
      _extend(finalQuery,query);

      // Replace data source IDs by their associated dumpOptions.
      // TODO make recursive.
      if (typeof Joshfire=="object" && Joshfire.getDataSource) {
        if (finalQuery.filter && finalQuery.filter.datasources) {
          for (k in finalQuery.filter.datasources) {
            if (finalQuery.filter.datasources[k] && finalQuery.filter.datasources.hasOwnProperty(k)) {
              finalQuery.filter.datasources[k] = Joshfire.config.datasources[finalQuery.filter.datasources[k]];
            }
          }
        }
      }

      //TODO json2.js
      if (finalQuery.filter) {
        finalQuery.filter = JSON.stringify(finalQuery.filter);
      }
      JSONP.get('http://' + config.DATAHOST + ':' + config.DATAPORT + '/api/'+ db +'/'+ colname, finalQuery, function(data) {
        callback(null,data);
      });
    };

    this.onLoaded = function(f) {
      f();
    };
  };


  var client = {
    getCollection: function(db, colname, options, callback) {
      return new collection(db,colname,options);
    },
    getCollectionDesc: function(db, colname, callback) {
      JSONP.get('http://' + config.DATAHOST + ':' + config.DATAPORT + '/api/'+ db +'/'+ colname + '/_desc', null, function(data) {
        callback(data);
      });
    }
  };

  window.DatajsProxy = window.Datajs = client;

})(JoshfirePlatformConfig||{});


  Joshfire.factory.getDataSource = function(datasourceName) {
    var ds = Joshfire.factory.config.datasources[datasourceName];
    if(toString.call(ds) == '[object Array]') {
      var ret = {
        children:[],
        find:function() {} //todo auto-all a union operator
      }; 
      for( var i = 0; i < ds.length; i++ ) {
        ret.children[i] = DatajsProxy.getCollection(ds[i].db, ds[i].col, ds[i].query);
        ret.children[i].config = ds[i];
      }
      return ret;
    } else {
      return DatajsProxy.getCollection(ds.db, ds.col, ds.query);
    }
  };

  window.Joshfire = Joshfire;

})();</script>
	
	<link rel="stylesheet" href="preview.css">
</head>
<body>

<div id="preview">Loading...</div>

<script>

	var skip = 0;
	var limit = 20;
	var maxid = false;

	var formatData = function (data) {
		var str = "";
		var i = 0;
		var entry = null;

		if (!data || !data.entries || !data.entries.length) {
			return "";
		}
		
		for (i = 0; i < data.entries.length; i++) {
			entry = data.entries[i];
			str += '<li>';
    
			if (entry.name) {
				str += '<h4>' + entry.name + '</h4>';
			}

			if (entry.thumbnailUrl) {
				str += '<p><img src="' + entry.thumbnailUrl + '" alt="" /></p>';
			}
			else if (entry.thumbnail && entry.thumbnail[0] && entry.thumbnail[0].contentURL) {
				str += '<p><img src="' + entry.thumbnail[0].contentURL + '" alt="" /></p>';
			}

			/*
			if (entry.description) {
				str += '<p>' + entry.description + '</p>';
			}
			*/

			str += '</li>';
			
			maxid = entry.url;
		}
		skip += data.entries.length;
		
		return str;
	};

	var loadMore = function (first) {
		var str = "";
		
		if (!first) {
			document.getElementById("preview-loadmore").innerHTML="Loading...";
		}
		
		var ds = Joshfire.factory.getDataSource("main");
		if (ds.children) ds = ds.children[0];
		var options = {skip:skip,limit:limit};
		if (maxid) options.maxid = maxid;
		ds.find(options,function (err, data) {
			if (err) {
				str = "An error occurred or the service may be temporarily down.";
			}
			else if (first) {
				if (!data || !data.entries || !data.entries.length) {
					str = 'No entries';
				}
				else {
					str = '<ul id="preview-ul"></ul><a id="preview-loadmore" onclick="loadMore(); return false;" href="#"></a>';
				}
				document.getElementById("preview").innerHTML = str;
			}

			if (document.getElementById("preview-loadmore")) {
				document.getElementById("preview-loadmore").innerHTML = "Load more";
				if (data && data.entries && data.entries.length) {
					document.getElementById("preview-ul").innerHTML += formatData(data);	
				}
			}
			
		});
	};

	loadMore(true);
	
</script>
</body>
</html>